<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analyse urine ‚Äî suivi perso</title>
  <meta name="theme-color" content="#111" />
  <style>
    :root{--bg:#0f1115;--panel:#171a20;--muted:#8b8f98;--text:#e7e9ee;--accent:#4f8cff;--ok:#38c172}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:680px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:8px 0 16px}
    h2{font-size:18px;margin:20px 0 10px}
    .card{background:var(--panel);border:1px solid #232733;border-radius:16px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    input,button{padding:10px;border-radius:12px;border:1px solid #313543;background:#0f1218;color:var(--text)}
    button{cursor:pointer}
    button.primary{background:var(--accent);color:white}
    button.success{background:var(--ok);color:black}
    .pill{padding:8px 10px;border-radius:999px;border:1px solid #2c3140;background:#161a24;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
    .pill.active{outline:2px solid var(--accent)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #262a36;padding:8px;text-align:left;font-size:14px;white-space:nowrap}
    .compact th,.compact td{font-size:12px;padding:6px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .itm{flex:1;min-width:120px;background:#10131a;border:1px solid #202433;border-radius:12px;padding:10px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#11151f;border:1px solid #2a3142;padding:10px 14px;border-radius:12px;color:white;opacity:0;transition:all .25s}
    .toast.show{opacity:1;bottom:26px}
    #errorBanner{background:#e53e3e;color:white;padding:10px;text-align:center;display:none}
    @media print{.btns,.toast,#errorBanner{display:none}}

    /* Pastilles rondes (couleurs) */
    .dot{display:inline-block;width:12px;height:12px;border-radius:50%;border:1px solid #333;vertical-align:middle}
    .d0{background:#ffffff}   /* tr√®s clair */
    .d1{background:#fff4cc}   /* clair */
    .d2{background:#ffe480}   /* jaune */
    .d3{background:#f7c04a}   /* jaune fonc√© */
    .d4{background:#d79a3c}   /* ambr√© */
  </style>
</head>
<body>
  <div id="errorBanner"></div>
  <div class="wrap" id="app">
    <h1>Analyse urine ‚Äî <span id="todayLabel"></span></h1>

    <div id="dash">
      <div class="card kpi" id="kpiRow"></div>

      <div class="card">
        <h2>J‚Äôurine</h2>
        <div class="grid2">
          <div>
            <label>Dur√©e (s)</label>
            <input id="durInput" type="number" min="0" placeholder="ex. 7" />
          </div>
          <div>
            <label>Urgence</label>
            <div class="row" id="urgRow"></div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <label>Retenue</label>
          <div class="row" id="holdRow"></div>
        </div>

        <div style="margin-top:10px">
          <label>Couleur</label>
          <div class="grid3" id="colorRow"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <label>Fuite ?</label>
          <div class="row" id="leakRow"></div>
        </div>

        <div class="right" style="margin-top:12px">
          <button class="primary" id="addUrineBtn">Valider</button>
        </div>
      </div>

      <div class="card">
        <h2>Je bois ou me l√®ve</h2>
        <div class="grid3">
          <button id="coffeeBtn">+1 caf√©</button>
          <button id="alcoholBtn">+1 alcool</button>
          <button id="nightBtn">+1 nuit</button>
        </div>
      </div>

      <div class="card" id="eodCard">
        <h2>Fin de journ√©e</h2>
        <div class="grid2">
          <input id="waterInput" type="number" step="0.1" min="0" placeholder="Eau bue (L)" />
          <input id="notesInput" type="text" placeholder="Notes" />
        </div>
        <div class="right" style="margin-top:12px">
          <button class="success" id="saveEodBtn">Valider fin de journ√©e</button>
        </div>
      </div>

      <div class="card">
        <h2>Tableau ‚Äî Jour</h2>
        <div class="btns" style="margin-bottom:8px">
          <button id="exportTimelineCsvBtn">Exporter chronologie (CSV)</button>
          <button id="exportAllCsvBtn">Exporter toutes les mictions (CSV)</button>
        </div>
        <table class="table" id="dayTable">
          <thead>
            <tr>
              <th>√âv√©nement</th><th>Heure</th><th>Dur√©e (s)</th><th>Couleur</th><th>Urgence</th><th>Fuite</th><th>Retenue</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>R√©capitulatif (par jour)</h2>
        <div class="btns" style="margin-bottom:8px">
          <button id="exportCsvBtn">Exporter R√©cap (CSV)</button>
          <button id="exportJsonBtn">Exporter JSON (backup)</button>
          <button id="importJsonBtn">Importer JSON</button>
          <button id="exportBothBtn">Exporter Mictions + R√©cap</button>
          <input type="file" id="importFile" accept="application/json" style="display:none" />
        </div>
        <table class="table compact" id="recapTable">
          <thead>
            <tr>
              <th>Date</th>
              <th title="Tr√®s clair"><span class="dot d0"></span></th>
              <th title="Clair"><span class="dot d1"></span></th>
              <th title="Jaune"><span class="dot d2"></span></th>
              <th title="Jaune fonc√©"><span class="dot d3"></span></th>
              <th title="Ambr√©"><span class="dot d4"></span></th>
              <th title="Total">Œ£</th>
              <th title="Eau (L)">üíß</th>
              <th title="Caf√©s">‚òï</th>
              <th title="Alcool">üç∫</th>
              <th title="Lev√©es nuit">üåô</th>
              <th title="Urgence moyenne">‚ö†</th>
              <th title="Fuites">üí¶</th>
              <th title="Notes">üìù</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ---------- Helpers & storage ---------- */
const $=s=>document.querySelector(s);
const store={get:()=>JSON.parse(localStorage.getItem('urine-app')||'{}'),set:d=>localStorage.setItem('urine-app',JSON.stringify(d))};
const todayKey=()=>new Date().toLocaleDateString('fr-CA',{timeZone:'Europe/Brussels'}); // YYYY-MM-DD
const timeNow=()=>new Date().toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
const toast=msg=>{const t=$('#toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1500)};

const BASE_DAY={urinations:[],timeline:[],water:null,notes:'',coffee:0,alcohol:0,night:0,locked:false};
function normalizeDay(day){
  const d={...BASE_DAY,...(day||{})};
  if(!Array.isArray(d.urinations)) d.urinations=[];
  if(!Array.isArray(d.timeline)) d.timeline=[];
  ['coffee','alcohol','night'].forEach(k=>{ if(!Number.isFinite(d[k])) d[k]=0; });
  if(typeof d.locked!=='boolean') d.locked=false;
  return d;
}
function getData(){const d=store.get();d.days=d.days||{};return d}
function getDay(d,key){d.days[key]=normalizeDay(d.days[key]);return d.days[key]}
function shortDate(iso){const [y,m,d]=iso.split('-');return `${d}/${m}/${String(y).slice(2)}`}
const COLOR_LABELS=['Tr√®s clair','Clair','Jaune','Jaune fonc√©','Ambr√©'];

/* ---------- KPIs & tables ---------- */
function refreshKpi(){
  const d=getData(), day=getDay(d,todayKey());
  const kpi=[{t:'Pipis',v:day.urinations.length},{t:'Eau (L)',v:day.water??'‚Äî'},{t:'Caf√©s',v:day.coffee},{t:'Alcool',v:day.alcohol},{t:'Nuit',v:day.night}];
  const row=$('#kpiRow'); row.innerHTML='';
  kpi.forEach(k=>{const div=document.createElement('div');div.className='itm';div.innerHTML=`<div>${k.t}</div><div style="font-size:20px">${k.v}</div>`;row.appendChild(div)});
}
function refreshDayTable(){
  const d=getData(), day=getDay(d,todayKey());
  const tb=$('#dayTable tbody'); tb.innerHTML='';
  // Timeline : si vide (anciens jours), reconstruire √† partir des mictions
  let timeline = day.timeline && day.timeline.length ? day.timeline.slice() : day.urinations.map(u=>({type:'miction', ...u}));
  // Trier par heure HH:mm
  timeline.sort((a,b)=>String(a.time).localeCompare(String(b.time)));
  timeline.forEach(ev=>{
    const tr=document.createElement('tr');
    if(ev.type==='miction'){
      tr.innerHTML=`<td>üíß Miction</td><td>${ev.time}</td><td>${ev.duration??''}</td><td>${COLOR_LABELS[ev.color]}</td><td>${ev.urgency}</td><td>${ev.leak?'Oui':'Non'}</td><td>${ev.hold?'Oui':'Non'}</td>`;
    }else if(ev.type==='coffee'){
      tr.innerHTML=`<td>‚òï Caf√©</td><td>${ev.time}</td><td></td><td></td><td></td><td></td><td></td>`;
    }else if(ev.type==='alcohol'){
      tr.innerHTML=`<td>üç∫ Alcool</td><td>${ev.time}</td><td></td><td></td><td></td><td></td><td></td>`;
    }
    tb.appendChild(tr);
  });
}
function refreshRecap(){
  const d=getData(); const keys=Object.keys(d.days).sort();
  const tb=$('#recapTable tbody'); tb.innerHTML='';
  keys.forEach(k=>{
    const day=getDay(d,k);
    const counts=[0,0,0,0,0]; day.urinations.forEach(u=>counts[u.color]++);
    const urg=day.urinations.length?(day.urinations.reduce((s,u)=>s+(u.urgency||0),0)/day.urinations.length):0;
    const leaks=day.urinations.reduce((s,u)=>s+(u.leak?1:0),0);
    const tr=document.createElement('tr');
    tr.innerHTML=
      `<td>${shortDate(k)}</td>`+
      `<td>${counts[0]}</td><td>${counts[1]}</td><td>${counts[2]}</td><td>${counts[3]}</td><td>${counts[4]}</td>`+
      `<td>${day.urinations.length}</td>`+
      `<td>${day.water!=null ? day.water + ' L' : ''}</td>`+
      `<td>${day.coffee}</td><td>${day.alcohol}</td><td>${day.night}</td>`+
      `<td>${urg.toFixed(1)}</td><td>${leaks}</td><td>${day.notes??''}</td>`;
    tb.appendChild(tr);
  });
}

/* ---------- Actions ---------- */
const state={color:2,urgency:0,leak:false,hold:false};
function buildPills(container,items,current,onPick){
  container.innerHTML='';
  items.forEach((item,i)=>{
    const b=document.createElement('div'); b.className='pill'+(current===i?' active':'');
    if(typeof item==='string'){ b.textContent=item; }
    else { b.innerHTML=item.html; b.title=item.title||''; }
    b.onclick=()=>{ onPick(i); buildPills(container,items,i,onPick); };
    container.appendChild(b);
  });
}
function buildColorPills(){
  const items=[
    {html:'<span class="dot d0"></span>', title:'Tr√®s clair'},
    {html:'<span class="dot d1"></span>', title:'Clair'},
    {html:'<span class="dot d2"></span>', title:'Jaune'},
    {html:'<span class="dot d3"></span>', title:'Jaune fonc√©'},
    {html:'<span class="dot d4"></span>', title:'Ambr√©'},
  ];
  buildPills($('#colorRow'), items, state.color, i=>state.color=i);
}
function addUrine(){
  const d=getData(), day=getDay(d,todayKey());
  const dur=parseInt($('#durInput').value,10)||0;
  const ev={time:timeNow(),duration:dur,color:state.color,urgency:state.urgency,leak:state.leak,hold:state.hold};
  day.urinations.push(ev);
  day.timeline.push({type:'miction', ...ev});
  store.set(d);
  $('#durInput').value='';
  refreshKpi(); refreshDayTable(); refreshRecap();
  toast('Miction ajout√©e');
}
function inc(field,msg){
  const d=getData(), day=getDay(d,todayKey());
  day[field]=(Number.isFinite(day[field])?day[field]:0)+1;
  const now=timeNow();
  if(field==='coffee') day.timeline.push({type:'coffee', time:now});
  if(field==='alcohol') day.timeline.push({type:'alcohol', time:now});
  store.set(d); refreshKpi(); refreshDayTable(); refreshRecap(); toast(msg);
}
function saveEod(){
  const d=getData(), day=getDay(d,todayKey());
  const w=parseFloat($('#waterInput').value); if(!isNaN(w)) day.water=w;
  const notes=$('#notesInput').value.trim(); if(notes) day.notes=notes;
  day.locked=true; store.set(d);
  refreshKpi(); refreshDayTable(); refreshRecap(); toast('Fin de journ√©e enregistr√©e');
}

/* ---------- Exports ---------- */
function exportCSV(){
  const d=getData();
  const headers=["Date","Tr√®s clair","Clair","Jaune","Jaune fonc√©","Ambr√©","Nombre pipis total","Eau (L)","Nombre tasses de caf√©","Nombre verres alcool","Nombre de fois lev√© la nuit","Urgence moy.","Fuites","Notes"];
  const rows=[headers];
  const keys=Object.keys(d.days).sort();
  keys.forEach(k=>{
    const day=getDay(d,k);
    const c=[0,0,0,0,0]; day.urinations.forEach(u=>c[u.color]++);
    const urg=day.urinations.length?(day.urinations.reduce((s,u)=>s+(u.urgency||0),0)/day.urinations.length):0;
    const leaks=day.urinations.reduce((s,u)=>s+(u.leak?1:0),0);
    rows.push([k,c[0],c[1],c[2],c[3],c[4],day.urinations.length,day.water??'',day.coffee,day.alcohol,day.night,urg.toFixed(1),leaks,day.notes??'']);
  });
  const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  download(csv,'recap-complet.csv','text/csv');
}
function exportAllCSV(){
  const d=getData();
  const rows=[["Date","Heure","Dur√©e (s)","Couleur","Urgence","Fuite","Retenue"]];
  const keys=Object.keys(d.days).sort();
  keys.forEach(k=>{
    const day=getDay(d,k);
    day.urinations.forEach(u=>{
      rows.push([k,u.time,u.duration,COLOR_LABELS[u.color],u.urgency,u.leak?'Oui':'Non',u.hold?'Oui':'Non']);
    });
  });
  const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  download(csv,'mictions-completes.csv','text/csv');
}
function exportTimelineCSV(){
  const d=getData();
  const rows=[["Date","Heure","√âv√©nement","Dur√©e (s)","Couleur","Urgence","Fuite","Retenue"]];
  const keys=Object.keys(d.days).sort();
  keys.forEach(k=>{
    const day=getDay(d,k);
    let tl = day.timeline && day.timeline.length ? day.timeline.slice() : day.urinations.map(u=>({type:'miction', ...u}));
    tl.sort((a,b)=>String(a.time).localeCompare(String(b.time)));
    tl.forEach(ev=>{
      if(ev.type==='miction'){
        rows.push([k,ev.time,'Miction',ev.duration,COLOR_LABELS[ev.color],ev.urgency,ev.leak?'Oui':'Non',ev.hold?'Oui':'Non']);
      }else if(ev.type==='coffee'){
        rows.push([k,ev.time,'Caf√©','','','','','']);
      }else if(ev.type==='alcohol'){
        rows.push([k,ev.time,'Alcool','','','','','']);
      }
    });
  });
  const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  download(csv,'chronologie-jour.csv','text/csv');
}
function exportJSON(){const d=getData();download(JSON.stringify(d,null,2),'backup-urine.json','application/json')}
function importJSON(ev){
  const f=ev.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{ try{ const parsed=JSON.parse(reader.result); store.set(parsed); refreshKpi(); refreshDayTable(); refreshRecap(); toast('Import JSON ok'); } catch(e){ toast('Import invalide'); } ev.target.value=''; };
  reader.readAsText(f);
}
function download(content,filename,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type}));a.download=filename;a.click();URL.revokeObjectURL(a.href)}

/* ---------- Init ---------- */
function init(){
  $('#todayLabel').textContent=new Date().toLocaleDateString('fr-BE',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric'});

  // Pastilles/choix
  buildPills($('#urgRow'), ['0','1','2','3'], 0, i=>state.urgency=i);
  buildPills($('#holdRow'), ['Non','Oui'], 0, i=>state.hold=(i===1));
  buildPills($('#leakRow'), ['Non','Oui'], 0, i=>state.leak=(i===1));
  buildColorPills();

  refreshKpi(); refreshDayTable(); refreshRecap();

  // Actions
  $('#addUrineBtn').onclick=addUrine;
  $('#coffeeBtn').onclick=()=>inc('coffee','+1 caf√©');
  $('#alcoholBtn').onclick=()=>inc('alcohol','+1 alcool');
  $('#nightBtn').onclick=()=>inc('night','+1 nuit');
  $('#saveEodBtn').onclick=saveEod;

  // Exports
  $('#exportTimelineCsvBtn').onclick=exportTimelineCSV;
  $('#exportAllCsvBtn').onclick=exportAllCSV;
  $('#exportCsvBtn').onclick=exportCSV;
  $('#exportJsonBtn').onclick=exportJSON;
  $('#importJsonBtn').onclick=()=>$('#importFile').click();
  $('#importFile').addEventListener('change',importJSON);
  $('#exportBothBtn').onclick=()=>{ exportAllCSV(); exportCSV(); toast('Exports g√©n√©r√©s'); };
}
window.addEventListener('error',e=>{const b=$('#errorBanner'); b.style.display='block'; b.textContent='Erreur JS: '+e.message;});
init();
</script>
</body>
</html>
