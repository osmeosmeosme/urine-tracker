<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analyse urine ‚Äî suivi perso</title>
  <meta name="theme-color" content="#111" />
  <style>
    :root{--bg:#0f1115;--panel:#171a20;--muted:#8b8f98;--text:#e7e9ee;--accent:#4f8cff;--ok:#38c172;--bad:#e53e3e}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:680px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:8px 0 16px}
    h2{font-size:18px;margin:20px 0 10px}
    .card{background:var(--panel);border:1px solid #232733;border-radius:16px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .stack{display:grid;grid-template-columns:1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    input,button,textarea,select{padding:10px;border-radius:12px;border:1px solid #313543;background:#0f1218;color:var(--text)}
    textarea{resize:vertical;min-height:120px}
    button{cursor:pointer}
    button.primary{background:var(--accent);color:white}
    button.success{background:var(--ok);color:black}
    button.danger{background:var(--bad);color:white}
    .pill{padding:8px 10px;border-radius:999px;border:1px solid #2c3140;background:#161a24;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
    .pill.active{outline:2px solid var(--accent)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #262a36;padding:8px;text-align:left;font-size:14px;white-space:nowrap}
    .compact th,.compact td{font-size:12px;padding:6px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .itm{flex:1;min-width:120px;background:#10131a;border:1px solid #202433;border-radius:12px;padding:10px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#11151f;border:1px solid #2a3142;padding:10px 14px;border-radius:12px;color:white;opacity:0;transition:all .25s}
    .toast.show{opacity:1;bottom:26px}
    #errorBanner{background:#e53e3e;color:white;padding:10px;text-align:center;display:none}
    .action-btn{padding:6px 8px;border-radius:8px; border:1px solid #2a3142; background:#151a24; font-size:13px}
    .action-btn + .action-btn{margin-left:6px}

    /* Pastilles rondes (couleurs) */
    .dot{display:inline-block;width:12px;height:12px;border-radius:50%;border:1px solid #333;vertical-align:middle;margin-right:6px}
    .d0{background:#ffffff}
    .d1{background:#fff4cc}
    .d2{background:#ffe480}
    .d3{background:#f7c04a}
    .d4{background:#d79a3c}

    /* Fin de journ√©e en colonne */
    #eodCard .stack{grid-template-columns:1fr}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal .box{background:#131722;border:1px solid #263044;border-radius:16px;max-width:520px;width:100%;padding:16px}
    .modal .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .modal .grid-1{display:grid;grid-template-columns:1fr;gap:10px}
    .modal .btns{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    @media print{.btns,.toast,#errorBanner,.action-btn,.modal{display:none}}
  </style>
</head>
<body>
  <div id="errorBanner"></div>
  <div class="wrap">
    <h1>Analyse urine ‚Äî <span id="todayLabel"></span></h1>

    <div class="card kpi" id="kpiRow"></div>

    <div class="card">
      <h2>J‚Äôurine</h2>
      <div class="stack">
        <div>
          <label>Dur√©e (s)</label>
          <input id="durInput" type="number" min="0" placeholder="ex. 7" />
        </div>
        <div>
          <label>Volume (mL) ‚Äî optionnel</label>
          <input id="volInput" type="number" min="0" step="1" placeholder="ex. 200" />
        </div>
        <div>
          <label>Urgence (0‚Äì3)</label>
          <div class="row" id="urgRow"></div>
        </div>
        <div>
          <label>Retenue</label>
          <div class="row" id="holdRow"></div>
        </div>
        <div>
          <label>Couleur</label>
          <div class="grid3" id="colorRow"></div>
        </div>
        <div>
          <label>Fuite ?</label>
          <div class="row" id="leakRow"></div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="primary" id="addUrineBtn">Valider</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Je bois ou me l√®ve</h2>
      <div class="grid3">
        <button id="coffeeBtn">+1 caf√©</button>
        <button id="alcoholBtn">+1 alcool</button>
        <button id="nightBtn">+1 nuit</button>
      </div>
    </div>

    <div class="card" id="eodCard">
      <h2>Fin de journ√©e</h2>
      <div class="stack">
        <div>
          <label>Eau bue (L)</label>
          <input id="waterInput" type="number" step="0.1" min="0" placeholder="ex. 2.3" />
        </div>
        <div>
          <label>Notes</label>
          <textarea id="notesInput" placeholder="ex. stress√©, entra√Ænement‚Ä¶"></textarea>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="success" id="saveEodBtn">Valider fin de journ√©e</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Tableau ‚Äî Jour</h2>
      <div class="btns" style="margin-bottom:8px">
        <button id="exportTimelineCsvBtn">Exporter chronologie (CSV)</button>
        <button id="exportAllCsvBtn">Exporter toutes les mictions (CSV)</button>
      </div>
      <table class="table" id="dayTable">
        <thead>
          <tr>
            <th title="√âv√©nement"></th>
            <th title="Heure">üïí</th>
            <th title="Dur√©e (s)">‚è±Ô∏è</th>
            <th title="Volume (mL)">üß™</th>
            <th title="Couleur">üé®</th>
            <th title="Urgence">‚ö†Ô∏è</th>
            <th title="Fuite">üí¶</th>
            <th title="Retenue">‚úã</th>
            <th title="Actions"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>R√©capitulatif (par jour)</h2>
      <div class="btns" style="margin-bottom:8px">
        <button id="exportCsvBtn">Exporter R√©cap (CSV)</button>
        <button id="exportJsonBtn">Exporter JSON (backup)</button>
        <button id="importJsonBtn">Importer JSON</button>
        <button id="exportBothBtn">Exporter Mictions + R√©cap</button>
        <input type="file" id="importFile" accept="application/json" style="display:none" />
      </div>
      <table class="table compact" id="recapTable">
        <thead>
          <tr>
            <th>Date</th>
            <th title="Tr√®s clair"><span class="dot d0"></span></th>
            <th title="Clair"><span class="dot d1"></span></th>
            <th title="Jaune"><span class="dot d2"></span></th>
            <th title="Jaune fonc√©"><span class="dot d3"></span></th>
            <th title="Ambr√©"><span class="dot d4"></span></th>
            <th title="Total">Œ£</th>
            <th title="Eau (L)">üíß</th>
            <th title="Caf√©s">‚òï</th>
            <th title="Alcool">üç∫</th>
            <th title="Lev√©es nuit">üåô</th>
            <th title="Urgence moyenne">‚ö†</th>
            <th title="Fuites">üí¶</th>
            <th title="Notes">üìù</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- MODAL EDIT -->
  <div class="modal" id="editModal" aria-hidden="true">
    <div class="box">
      <div class="hdr">
        <h3 id="editTitle" style="margin:0">Modifier</h3>
        <button class="action-btn" id="closeModalBtn">‚úï</button>
      </div>

      <div class="grid">
        <div>
          <label>Type</label>
          <select id="editType">
            <option value="miction">Miction</option>
            <option value="coffee">Caf√©</option>
            <option value="alcohol">Alcool</option>
          </select>
        </div>
        <div>
          <label>Heure</label>
          <input id="editTime" type="time" />
        </div>
      </div>

      <div id="editMictionFields" class="grid">
        <div>
          <label>Dur√©e (s)</label>
          <input id="editDur" type="number" min="0" />
        </div>
        <div>
          <label>Volume (mL)</label>
          <input id="editVol" type="number" min="0" step="1" />
        </div>
        <div>
          <label>Couleur</label>
          <select id="editColor">
            <option value="0">Tr√®s clair</option>
            <option value="1">Clair</option>
            <option value="2">Jaune</option>
            <option value="3">Jaune fonc√©</option>
            <option value="4">Ambr√©</option>
          </select>
        </div>
        <div>
          <label>Urgence (0‚Äì3)</label>
          <select id="editUrg">
            <option>0</option><option>1</option><option>2</option><option>3</option>
          </select>
        </div>
        <div>
          <label>Fuite</label>
          <select id="editLeak"><option>Non</option><option>Oui</option></select>
        </div>
        <div>
          <label>Retenue</label>
          <select id="editHold"><option>Non</option><option>Oui</option></select>
        </div>
      </div>

      <div class="btns">
        <button class="danger" id="deleteBtn">üóëÔ∏è Supprimer</button>
        <button class="success" id="saveEditBtn">üíæ Enregistrer</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ===== Helpers & storage ===== */
const $ = s => document.querySelector(s);
const store = { get: () => JSON.parse(localStorage.getItem('urine-app') || '{}'), set: d => localStorage.setItem('urine-app', JSON.stringify(d)) };
const todayKey = () => new Date().toLocaleDateString('fr-CA',{timeZone:'Europe/Brussels'}); // YYYY-MM-DD
const timeNow  = () => new Date().toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
const toast = msg => { const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); };

const BASE_DAY = { urinations:[], timeline:[], water:null, notes:'', coffee:0, alcohol:0, night:0, locked:false };
const COLOR_LABELS = ['Tr√®s clair','Clair','Jaune','Jaune fonc√©','Ambr√©'];

/* ===== Migration (pr√©serve 100% des donn√©es) ===== */
function migrateData(d){
  d.days = d.days || {};
  for(const k of Object.keys(d.days)){
    const day = d.days[k] || {};
    if(!Array.isArray(day.urinations)) day.urinations = [];
    if(!Array.isArray(day.timeline)) day.timeline = day.urinations.map(u=>({type:'miction', ...u}));
    if(typeof day.coffee !== 'number') day.coffee = 0;
    if(typeof day.alcohol !== 'number') day.alcohol = 0;
    if(typeof day.night !== 'number') day.night = 0;
    if(typeof day.locked !== 'boolean') day.locked = false;
    d.days[k] = day;
  }
  return d;
}
function getData(){ let d=store.get(); d=migrateData(d); store.set(d); return d; }
function getDay(d,key){ d.days[key] = d.days[key] || {...BASE_DAY}; d.days[key]=migrateData({days:{[key]:d.days[key]}}).days[key]; return d.days[key]; }
function shortDate(iso){ const [y,m,d]=iso.split('-'); return `${d}/${m}/${String(y).slice(2)}`; }

/* ===== State ===== */
const state = { color:2, urgency:0, leak:false, hold:false };

/* ===== UI builders ===== */
function buildPills(container, items, current, onPick){
  container.innerHTML='';
  items.forEach((item,i)=>{
    const b=document.createElement('div');
    b.className='pill'+(current===i?' active':'');
    if(typeof item==='string'){ b.textContent=item; } else { b.innerHTML=item.html; b.title=item.title||''; }
    b.onclick=()=>{ onPick(i); buildPills(container, items, i, onPick); };
    container.appendChild(b);
  });
}
function buildColorPills(){
  const items=[
    {html:'<span class="dot d0"></span>', title:'Tr√®s clair'},
    {html:'<span class="dot d1"></span>', title:'Clair'},
    {html:'<span class="dot d2"></span>', title:'Jaune'},
    {html:'<span class="dot d3"></span>', title:'Jaune fonc√©'},
    {html:'<span class="dot d4"></span>', title:'Ambr√©'},
  ];
  buildPills($('#colorRow'), items, state.color, i=>state.color=i);
}

/* ===== Render ===== */
function refreshKpi(){
  const d=getData(), day=getDay(d,todayKey());
  const kpi=[{t:'Pipis',v:day.urinations.length},{t:'Eau (L)',v:day.water??'‚Äî'},{t:'Caf√©s',v:day.coffee},{t:'Alcool',v:day.alcohol},{t:'Nuit',v:day.night}];
  const row=$('#kpiRow'); row.innerHTML='';
  kpi.forEach(k=>{const div=document.createElement('div');div.className='itm';div.innerHTML=`<div>${k.t}</div><div style="font-size:20px">${k.v}</div>`;row.appendChild(div);});
}
function refreshDayTable(){
  const d=getData(), day=getDay(d,todayKey());
  const tb=$('#dayTable tbody'); tb.innerHTML='';

  // Build pairs {idx, ev} where idx is the index inside timeline
  const list = (day.timeline||[]).map((ev,idx)=>({idx, ev}));
  list.sort((a,b)=>String(a.ev.time||'').localeCompare(String(b.ev.time||'')));

  list.forEach(({idx,ev})=>{
    const tr=document.createElement('tr');
    if(ev.type==='miction'){
      tr.innerHTML=
        `<td title="Miction">üåä</td>`+
        `<td>${ev.time||''}</td>`+
        `<td>${ev.duration??''}</td>`+
        `<td>${(ev.volume!=null && !isNaN(ev.volume))?ev.volume:''}</td>`+
        `<td><span class="dot d${ev.color??2}"></span>${COLOR_LABELS[ev.color??2]}</td>`+
        `<td>${ev.urgency??''}</td>`+
        `<td>${ev.leak?'Oui':'Non'}</td>`+
        `<td>${ev.hold?'Oui':'Non'}</td>`+
        `<td><button class="action-btn" onclick="openEdit(${idx})">‚úèÔ∏è</button><button class="action-btn" onclick="deleteRow(${idx})">üóëÔ∏è</button></td>`;
    }else if(ev.type==='coffee'){
      tr.innerHTML=
        `<td title="Caf√©">‚òï</td><td>${ev.time||''}</td><td></td><td></td><td></td><td></td><td></td><td></td>`+
        `<td><button class="action-btn" onclick="openEdit(${idx})">‚úèÔ∏è</button><button class="action-btn" onclick="deleteRow(${idx})">üóëÔ∏è</button></td>`;
    }else if(ev.type==='alcohol'){
      tr.innerHTML=
        `<td title="Alcool">üç∫</td><td>${ev.time||''}</td><td></td><td></td><td></td><td></td><td></td><td></td>`+
        `<td><button class="action-btn" onclick="openEdit(${idx})">‚úèÔ∏è</button><button class="action-btn" onclick="deleteRow(${idx})">üóëÔ∏è</button></td>`;
    }
    tb.appendChild(tr);
  });
}
function refreshRecap(){
  const d=getData(); const keys=Object.keys(d.days).sort(); const tb=$('#recapTable tbody'); tb.innerHTML='';
  keys.forEach(k=>{
    const day=getDay(d,k);
    const counts=[0,0,0,0,0]; (day.urinations||[]).forEach(u=>{ const c=(u.color??2); if(Number.isFinite(c)&&counts[c]!=null) counts[c]++; });
    const urg=(day.urinations||[]).length?((day.urinations||[]).reduce((s,u)=>s+(u.urgency||0),0)/(day.urinations||[]).length):0;
    const leaks=(day.urinations||[]).reduce((s,u)=>s+(u.leak?1:0),0);
    const tr=document.createElement('tr');
    tr.innerHTML =
      `<td>${shortDate(k)}</td>`+
      `<td>${counts[0]}</td><td>${counts[1]}</td><td>${counts[2]}</td><td>${counts[3]}</td><td>${counts[4]}</td>`+
      `<td>${(day.urinations||[]).length}</td>`+
      `<td>${day.water!=null ? day.water + ' L' : ''}</td>`+
      `<td>${day.coffee||0}</td><td>${day.alcohol||0}</td><td>${day.night||0}</td>`+
      `<td>${isFinite(urg)?urg.toFixed(1):''}</td><td>${leaks}</td><td>${day.notes??''}</td>`;
    tb.appendChild(tr);
  });
}

/* ===== Actions ===== */
function addUrine(){
  const d=getData(), day=getDay(d,todayKey());
  const dur = parseInt($('#durInput').value,10) || 0;
  const vol = parseFloat($('#volInput').value);
  const ev = { time: timeNow(), duration: dur, volume:(isNaN(vol)?undefined:vol), color: state.color, urgency: state.urgency, leak: state.leak, hold: state.hold };
  day.urinations.push(ev);
  day.timeline.push({type:'miction', ...ev});
  store.set(d);
  $('#durInput').value=''; $('#volInput').value='';
  refreshKpi(); refreshDayTable(); refreshRecap();
  toast('Miction ajout√©e');
}
function inc(field,msg){
  const d=getData(), day=getDay(d,todayKey());
  day[field]=(Number.isFinite(day[field])?day[field]:0)+1;
  const now=timeNow();
  if(field==='coffee') day.timeline.push({type:'coffee', time:now});
  if(field==='alcohol') day.timeline.push({type:'alcohol', time:now});
  store.set(d);
  refreshKpi(); refreshDayTable(); refreshRecap(); toast(msg);
}
function saveEod(){
  const d=getData(), day=getDay(d,todayKey());
  const w=parseFloat($('#waterInput').value); if(!isNaN(w)) day.water=w;
  const notes=$('#notesInput').value.trim(); if(notes) day.notes=notes;
  day.locked=true; store.set(d);
  refreshKpi(); refreshDayTable(); refreshRecap(); toast('Fin de journ√©e enregistr√©e');
}

/* ===== Edit / Delete ===== */
let editingIndex = null; // index dans day.timeline d‚Äôaujourd‚Äôhui

function openEdit(idx){
  editingIndex = idx;
  const d=getData(), day=getDay(d,todayKey());
  const ev = day.timeline[idx]; if(!ev){ toast('√âl√©ment introuvable'); return; }

  // Remplir le formulaire
  $('#editType').value = ev.type || 'miction';
  $('#editTime').value = (ev.time && ev.time.length===5) ? ev.time : (ev.time||'').slice(0,5);

  if(ev.type==='miction'){
    $('#editMictionFields').style.display='grid';
    $('#editDur').value = ev.duration ?? '';
    $('#editVol').value = (ev.volume!=null && !isNaN(ev.volume)) ? ev.volume : '';
    $('#editColor').value = String(ev.color ?? 2);
    $('#editUrg').value   = String(ev.urgency ?? 0);
    $('#editLeak').value  = ev.leak ? 'Oui' : 'Non';
    $('#editHold').value  = ev.hold ? 'Oui' : 'Non';
  }else{
    $('#editMictionFields').style.display='none';
    $('#editDur').value = ''; $('#editVol').value=''; // nettoie
  }

  $('#editModal').style.display='flex';
  $('#editTitle').textContent = ev.type==='miction' ? 'Modifier la miction' : (ev.type==='coffee'?'Modifier le caf√©':'Modifier l‚Äôalcool');
}
$('#editType').addEventListener('change',()=>{
  const v=$('#editType').value;
  $('#editMictionFields').style.display = (v==='miction') ? 'grid' : 'none';
});

$('#closeModalBtn').onclick = ()=>{ $('#editModal').style.display='none'; editingIndex=null; };

$('#saveEditBtn').onclick = ()=>{
  if(editingIndex==null) return;
  const d=getData(), day=getDay(d,todayKey());
  const ev = day.timeline[editingIndex]; if(!ev){ toast('√âl√©ment introuvable'); return; }

  const newType = $('#editType').value;
  const newTime = $('#editTime').value || (ev.time||'');
  const hhmm = newTime.length===5 ? newTime : (String(newTime).slice(0,5));

  if(newType==='miction'){
    const dur = parseInt($('#editDur').value,10);
    const vol = parseFloat($('#editVol').value);
    const color = parseInt($('#editColor').value,10);
    const urg = parseInt($('#editUrg').value,10);
    const leak = $('#editLeak').value==='Oui';
    const hold = $('#editHold').value==='Oui';

    // Mettre √† jour timeline
    day.timeline[editingIndex] = {type:'miction', time: hhmm, duration: isNaN(dur)?undefined:dur, volume:(isNaN(vol)?undefined:vol), color: (Number.isFinite(color)?color:2), urgency: (Number.isFinite(urg)?urg:0), leak, hold};

    // Mettre √† jour aussi la collection urinations si l‚Äô√©l√©ment existait comme miction
    // Trouver la miction correspondante (par l‚Äôancienne heure+valeurs). Si aucune correspondance, on essaie meilleur-effort par index proche de fin.
    // Ici, strat√©gie simple : si ev.type √©tait miction, on remplace la premi√®re miction du jour √† la m√™me heure, sinon on en ajoute une nouvelle coh√©rente.
    if(ev.type==='miction'){
      const i = (day.urinations||[]).findIndex(u=>u.time===ev.time && u.duration===ev.duration && u.color===ev.color && u.urgency===ev.urgency && !!u.leak===!!ev.leak && !!u.hold===!!ev.hold);
      const newU = {time:hhmm, duration:isNaN(dur)?undefined:dur, volume:(isNaN(vol)?undefined:vol), color:(Number.isFinite(color)?color:2), urgency:(Number.isFinite(urg)?urg:0), leak, hold};
      if(i>=0) day.urinations[i] = newU; else day.urinations.push(newU);
    }else{
      // converti d‚Äôun caf√©/alcool vers miction -> on ajoute la miction
      day.urinations.push({time:hhmm, duration:isNaN(dur)?undefined:dur, volume:(isNaN(vol)?undefined:vol), color:(Number.isFinite(color)?color:2), urgency:(Number.isFinite(urg)?urg:0), leak, hold});
      // et on incr√©mente KPI si besoin ? (non, KPIs s‚Äôappuient sur urinations[].length pour pipis ; pas besoin d‚Äôajouter autre chose)
    }

  }else{
    // Changement vers caf√©/alcool (ou simple √©dition d‚Äôheure)
    day.timeline[editingIndex] = {type:newType, time: hhmm};

    // Si on convertit une miction vers caf√©/alcool, on retire la miction associ√©e des urinations
    if(ev.type==='miction'){
      const i = (day.urinations||[]).findIndex(u=>u.time===ev.time && u.duration===ev.duration && u.color===ev.color && u.urgency===ev.urgency && !!u.leak===!!ev.leak && !!u.hold===!!ev.hold);
      if(i>=0) day.urinations.splice(i,1);
    }
    // Ajuster KPI caf√©s/alcools selon conversion
    if(ev.type!=='coffee' && newType==='coffee'){ day.coffee=(day.coffee||0)+1; }
    if(ev.type==='coffee' && newType!=='coffee'){ day.coffee=Math.max(0,(day.coffee||0)-1); }
    if(ev.type!=='alcohol' && newType==='alcohol'){ day.alcohol=(day.alcohol||0)+1; }
    if(ev.type==='alcohol' && newType!=='alcohol'){ day.alcohol=Math.max(0,(day.alcohol||0)-1); }
  }

  store.set(d);
  $('#editModal').style.display='none'; editingIndex=null;
  refreshKpi(); refreshDayTable(); refreshRecap();
  toast('Modifi√©');
};

function deleteRow(idx){
  const d=getData(), day=getDay(d,todayKey());
  const ev = day.timeline[idx]; if(!ev){ toast('√âl√©ment introuvable'); return; }

  // Retirer des collections
  if(ev.type==='miction'){
    const i = (day.urinations||[]).findIndex(u=>u.time===ev.time && u.duration===ev.duration && u.color===ev.color && u.urgency===ev.urgency && !!u.leak===!!ev.leak && !!u.hold===!!ev.hold);
    if(i>=0) day.urinations.splice(i,1);
  }else if(ev.type==='coffee'){ day.coffee=Math.max(0,(day.coffee||0)-1); }
  else if(ev.type==='alcohol'){ day.alcohol=Math.max(0,(day.alcohol||0)-1); }

  day.timeline.splice(idx,1);
  store.set(d);
  refreshKpi(); refreshDayTable(); refreshRecap();
  toast('Supprim√©');
}

/* ===== Exports ===== */
function exportCSV(){
  const d=getData(); const rows=[["Date","Tr√®s clair","Clair","Jaune","Jaune fonc√©","Ambr√©","Nombre pipis total","Eau (L)","Nombre tasses de caf√©","Nombre verres alcool","Nombre de fois lev√© la nuit","Urgence moy.","Fuites","Notes"]];
  Object.keys(d.days).sort().forEach(k=>{
    const day=getDay(d,k); const c=[0,0,0,0,0]; (day.urinations||[]).forEach(u=>{const idx=u.color??2; if(c[idx]!=null)c[idx]++;});
    const urg=(day.urinations||[]).length?((day.urinations||[]).reduce((s,u)=>s+(u.urgency||0),0)/(day.urinations||[]).length):0;
    const leaks=(day.urinations||[]).reduce((s,u)=>s+(u.leak?1:0),0);
    rows.push([k,c[0],c[1],c[2],c[3],c[4],(day.urinations||[]).length,day.water??'',day.coffee||0,day.alcohol||0,day.night||0,isFinite(urg)?urg.toFixed(1):'',leaks,day.notes??'']);
  });
  const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  download(csv,'recap-complet.csv','text/csv');
}
function exportAllCSV(){
  const d=getData(); const rows=[["Date","Heure","Dur√©e (s)","Volume (mL)","Couleur","Urgence","Fuite","Retenue"]];
  Object.keys(d.days).sort().forEach(k=>{
    const day=getDay(d,k);
    (day.urinations||[]).forEach(u=>{
      rows.push([k,u.time||'',u.duration,(u.volume!=null && !isNaN(u.volume))?u.volume:'',COLOR_LABELS[u.color??2],u.urgency,u.leak?'Oui':'Non',u.hold?'Oui':'Non']);
    });
  });
  const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  download(csv,'mictions-completes.csv','text/csv');
}
function exportTimelineCSV(){
  const d=getData(); const rows=[["Date","Heure","√âv√©nement","Dur√©e (s)","Volume (mL)","Couleur","Urgence","Fuite","Retenue"]];
  Object.keys(d.days).sort().forEach(k=>{
    const day=getDay(d,k); let tl = Array.isArray(day.timeline)?day.timeline.slice():[];
    if(tl.length===0 && Array.isArray(day.urinations)) tl = day.urinations.map(u=>({type:'miction', ...u}));
    tl.sort((a,b)=>String(a.time).localeCompare(String(b.time)));
    tl.forEach(ev=>{
      if(ev.type==='miction') rows.push([k,ev.time||'','Miction',ev.duration,(ev.volume!=null && !isNaN(ev.volume))?ev.volume:'',COLOR_LABELS[ev.color??2],ev.urgency,ev.leak?'Oui':'Non',ev.hold?'Oui':'Non']);
      else if(ev.type==='coffee') rows.push([k,ev.time||'','Caf√©','','','','','','']);
      else if(ev.type==='alcohol') rows.push([k,ev.time||'','Alcool','','','','','','']);
    });
  });
  const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  download(csv,'chronologie-jour.csv','text/csv');
}
function exportJSON(){ const d=getData(); download(JSON.stringify(d,null,2),'backup-urine.json','application/json'); }
function importJSON(ev){
  const f=ev.target.files[0]; if(!f) return;
  const rd=new FileReader();
  rd.onload=()=>{ try{ const parsed=JSON.parse(rd.result); store.set(parsed); toast('Import JSON ok'); refreshKpi(); refreshDayTable(); refreshRecap(); } catch(e){ toast('Import invalide'); } ev.target.value=''; };
  rd.readAsText(f);
}
function download(content,filename,type){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type})); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }

/* ===== Init ===== */
function init(){
  $('#todayLabel').textContent=new Date().toLocaleDateString('fr-BE',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric'});

  buildPills($('#urgRow'), ['0','1','2','3'], 0, i=>state.urgency=i);
  buildPills($('#holdRow'), ['Non','Oui'], 0, i=>state.hold=(i===1));
  buildPills($('#leakRow'), ['Non','Oui'], 0, i=>state.leak=(i===1));
  buildColorPills();

  refreshKpi(); refreshDayTable(); refreshRecap();

  $('#addUrineBtn').onclick = addUrine;
  $('#coffeeBtn').onclick  = () => inc('coffee','+1 caf√©');
  $('#alcoholBtn').onclick = () => inc('alcohol','+1 alcool');
  $('#nightBtn').onclick   = () => inc('night','+1 nuit');
  $('#saveEodBtn').onclick = saveEod;

  $('#exportTimelineCsvBtn').onclick = exportTimelineCSV;
  $('#exportAllCsvBtn').onclick      = exportAllCSV;
  $('#exportCsvBtn').onclick         = exportCSV;
  $('#exportJsonBtn').onclick        = exportJSON;
  $('#importJsonBtn').onclick        = () => $('#importFile').click();
  $('#importFile').addEventListener('change', importJSON);
  $('#exportBothBtn').onclick        = () => { exportAllCSV(); exportCSV(); toast('Exports g√©n√©r√©s'); };
}
window.addEventListener('error',e=>{ const b=$('#errorBanner'); b.style.display='block'; b.textContent='Erreur JS : '+e.message; });
init();
</script>
</body>
</html>
